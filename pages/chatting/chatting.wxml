<!-- pages/chatting/chatting.wxml -->
<view class="bg-background-light min-h-screen flex flex-col pb-20">
  <!-- Header -->
  <view class="sticky top-0 z-50 bg-background-light-90 backdrop-blur-md border-b border-gray-200">
    <view class="px-4 py-3 flex items-center justify-center relative">
      <view class="text-lg font-bold text-center">Êô∫ËÉΩÂä©Êâã</view>
    </view>
  </view>

  <!-- Chat Content -->
  <scroll-view scroll-y="true" class="flex-1 px-4 py-6 space-y-6" style="height: calc(100vh - 160rpx);">
    <block wx:for="{{chatList}}" wx:key="index">
      <!-- Date/Time (Optional, using item.date) -->
      <view class="flex justify-center mb-4" wx:if="{{item.date}}">
        <view class="text-xs text-text-sub-light bg-gray-200 px-2 py-1 rounded-md">{{item.date}}</view>
      </view>

      <!-- Robot Message -->
      <view class="flex items-start gap-4 mb-4" wx:if="{{item.msgId !== login.id}}">
        <view class="flex-shrink-0 w-10 h-10 rounded-full bg-primary flex items-center justify-center shadow-md">
           <image src="https://picture-lsz.oss-cn-shanghai.aliyuncs.com/wechat/static/robot.png" class="w-8 h-8" />
        </view>
        <view class="relative max-w-80pct">
          <view class="bg-surface-light p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100">
            <text class="text-base leading-relaxed text-text-main-light" user-select="true">{{item.message}}</text>
          </view>
        </view>
      </view>

      <!-- User Message -->
      <view class="flex items-start justify-end gap-4 mb-4" wx:if="{{item.msgId === login.id}}">
        <view class="relative max-w-80pct">
          <view class="bg-primary p-4 rounded-2xl rounded-tr-none shadow-md">
            <text class="text-base leading-relaxed text-white" user-select="true">{{item.message}}</text>
          </view>
        </view>
        <view class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden shadow-sm">
           <image class="w-full h-full" src="{{item.avatar}}" mode="aspectFill"></image>
        </view>
      </view>
    </block>
    <view style="height: 100rpx;"></view> <!-- Spacer for bottom input -->
  </scroll-view>

  <!-- Footer Input Area -->
  <view class="fixed bottom-0 left-0 right-0 bg-surface-light border-t border-gray-200 z-40 transition-all duration-300" style="padding-bottom: {{functionShow ? '0' : '32rpx'}}">
    <view class="p-3">
        <view class="flex items-end gap-4">
        <view class="flex-1 relative">
            <textarea 
                class="w-full px-4 bg-gray-100 border-none rounded-2xl text-text-main-light placeholder-gray-400" 
                placeholder="ËØ∑ËæìÂÖ•ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÊ∂àÊÅØ" 
                auto-height="true"
                maxlength="500"
                cursor-spacing="20"
                value="{{content}}" 
                bindinput="inputClick"
                style="min-height: 80rpx; max-height: 200rpx; line-height: 1.5; padding-top: 16rpx; padding-bottom: 16rpx;"
            ></textarea>
        </view>
        <view class="flex gap-2 items-center h-full pb-1">
            <!-- Plus Button (CSS Icon) -->
            <view class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full text-text-sub-light hover-bg-gray-100 transition-colors border border-gray-200 relative" bindtap="showFunction">
            <view class="w-4 h-0.5 bg-gray-500 rounded-full absolute transition-transform duration-300 {{functionShow ? 'rotate-45' : ''}}"></view>
            <view class="w-0.5 h-4 bg-gray-500 rounded-full absolute transition-transform duration-300 {{functionShow ? 'rotate-45' : ''}}"></view>
            <text class="text-lg">‚ûï</text>
            </view>

            <!-- Voice Input Button (Êåâ‰ΩèÂΩïÈü≥) -->
            <view
              class="flex-shrink-0 w-14 h-14 flex items-center justify-center rounded-full {{isRecording ? 'bg-red-500 scale-110' : 'bg-primary'}} transition-all duration-200 shadow-md hover:shadow-lg"
              bindtouchstart="startRecording"
              bindtouchend="stopRecording"
              bindtouchcancel="cancelRecording">
              <!-- È∫¶ÂÖãÈ£é Emoji -->
              <text class="text-2xl {{isRecording ? 'animate-pulse' : ''}}">üé§</text>
            </view>

            <!-- Send Button (Dynamic Color) -->
            <view class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full {{content.length > 0 ? 'bg-primary hover-bg-blue-600' : 'bg-gray-300'}} transition-colors shadow-sm text-white" bindtap="sendClick">
              <!-- ÂèëÈÄÅ Emoji -->
              <text class="text-lg">‚úàÔ∏è</text>
            </view>
        </view>
        </view>
    </view>

    <!-- Function Panel (Flow layout inside footer) -->
    <view class="bg-surface-light overflow-hidden transition-all duration-300 ease-in-out" style="height: {{functionShow ? '320rpx' : '0'}};">
        <view class="p-6 pt-4 border-t border-gray-100">
            <view class="flex items-start justify-between">
                <!-- ÁÖßÁâáÊåâÈíÆ -->
                <view class="flex flex-col items-center gap-3" bindtap="menuFun" data-type="photo">
                    <view class="w-12 h-12 bg-gray-50 rounded-2xl border border-gray-100 flex items-center justify-center">
                      <text class="text-2xl">üñºÔ∏è</text>
                    </view>
                    <text class="text-xs text-text-sub-light text-center">ÁÖßÁâá</text>
                </view>

                <!-- Áõ∏Êú∫ÊåâÈíÆ -->
                <view class="flex flex-col items-center gap-3" bindtap="menuFun" data-type="camera">
                    <view class="w-12 h-12 bg-gray-50 rounded-2xl border border-gray-100 flex items-center justify-center">
                      <text class="text-2xl">üì∑</text>
                    </view>
                    <text class="text-xs text-text-sub-light text-center">ÊãçÊëÑ</text>
                </view>

                <!-- Âà†Èô§ËÅäÂ§©ËÆ∞ÂΩïÊåâÈíÆ -->
                <view class="flex flex-col items-center gap-3" bindtap="menuFun" data-type="chatting">
                    <view class="w-12 h-12 bg-gray-50 rounded-2xl border border-gray-100 flex items-center justify-center">
                      <text class="text-2xl">üóëÔ∏è</text>
                    </view>
                    <text class="text-xs text-text-sub-light text-center">Ê∏ÖÁ©∫ËÆ∞ÂΩï</text>
                </view>
            </view>
        </view>
    </view>
  </view>
</view>
