# 团队协作配置指南

## 🔒 敏感信息管理说明

为了确保项目的安全性，我们采用了**配置文件分离**的策略，将敏感信息（API密钥、数据库连接字符串等）与代码分离。

---

## 📁 配置文件结构

```
LOT_MCU/
├── config/
│   ├── xfyun.config.example.js    # 示例配置文件（已提交到Git）
│   └── xfyun.config.js            # 实际配置文件（已被.gitignore忽略）
├── .gitignore                      # Git忽略文件列表
└── docs/
    └── 团队协作配置指南.md          # 本文档
```

---

## ⚙️ 新团队成员配置步骤

### 第一步：获取项目代码

```bash
git clone <repository-url>
cd LOT_MCU
```

### 第二步：创建配置文件

进入 `config` 目录，你会看到 `xfyun.config.example.js` 文件。

**复制示例文件创建实际配置文件：**

```bash
cd config
cp xfyun.config.example.js xfyun.config.js
```

### 第三步：填写API密钥信息

打开 `config/xfyun.config.js`，填写你的API密钥：

```javascript
module.exports = {
  xfyun: {
    appId: '你的APPID',           // ← 填写真实值
    apiKey: '你的APIKey',         // ← 填写真实值
    apiSecret: '你的APISecret',   // ← 填写真实值
    host: 'iat.cn-huabei-1.xf-yun.com',
    path: '/v1'
  }
};
```

### 第四步：验证配置

1. 确保配置文件格式正确（无语法错误）
2. 检查 `config/xfyun.config.js` 是否已在 `.gitignore` 中
3. 运行项目测试功能是否正常

---

## 🔑 获取科大讯飞API密钥

### 注册账号

1. 访问 [讯飞开放平台](https://www.xfyun.cn/)
2. 注册并登录账号
3. 完成实名认证

### 创建应用

1. 进入**控制台** → **我的应用**
2. 点击「创建新应用」
3. 填写应用名称和描述

### 添加服务

1. 在应用详情页，点击「添加新服务」
2. 选择 **「方言识别大模型」**
3. 同意服务协议

### 查看密钥

在应用详情页面，可以看到三个重要参数：

| 参数名 | 说明 | 位置 |
|--------|------|------|
| **APPID** | 应用ID | 应用信息卡片 |
| **APIKey** | API密钥 | API信息栏 |
| **APISecret** | API密钥 | API信息栏 |

---

## ⚠️ 安全注意事项

### ✅ 应该做的

1. **永远不要提交包含真实密钥的配置文件到Git**
   ```bash
   # 检查文件是否被忽略
   git check-ignore config/xfyun.config.js
   # 如果输出文件路径，说明已被正确忽略
   ```

2. **定期更换API密钥**
   - 建议每3-6个月更换一次
   - 发现密钥泄露立即更换

3. **使用不同的密钥用于不同环境**
   - 开发环境使用测试密钥
   - 生产环境使用正式密钥
   - 不要在多个项目中共享同一组密钥

4. **设置每日使用上限**
   - 在讯飞控制台设置每日最大调用量
   - 避免密钥泄露时产生高额费用

### ❌ 不应该做的

1. **不要在代码中硬编码密钥**
   ```javascript
   // ❌ 错误做法
   const apiKey = '7462e2c3-ffa0-4da7-9227-5f78c59305d8';

   // ✅ 正确做法
   const config = require('../../config/xfyun.config.js');
   const apiKey = config.xfyun.apiKey;
   ```

2. **不要在公开场合讨论密钥信息**
   - 避免在GitHub Issues、论坛等公开渠道提及
   - 使用私密渠道（邮件、私聊）交流

3. **不要将密钥写入日志文件**
   ```javascript
   // ❌ 错误做法
   console.log('API Key:', apiKey);

   // ✅ 正确做法
   console.log('API配置已加载');
   ```

4. **不要在客户端代码中包含生产环境密钥**
   - 微信小程序代码可以被反编译
   - 考虑使用服务器中转方案

---

## 🛡️ 生产环境安全建议

### 方案一：服务器中转（推荐）

```
小程序 → 你的服务器 → 科大讯飞API
```

**优点**：
- ✅ 密钥不暴露在客户端
- ✅ 可以添加访问控制
- ✅ 便于监控和限流

**实现示例**：

```javascript
// 小程序端
wx.request({
  url: 'https://your-server.com/api/voice-recognize',
  method: 'POST',
  data: { audioData: audioBase64 }
});

// 服务器端（Node.js）
app.post('/api/voice-recognize', async (req, res) => {
  const config = require('./config/xfyun.config.js');
  // 调用讯飞API
  const result = await xfyunAPI.recognize(req.body.audioData, config);
  res.json(result);
});
```

### 方案二：使用环境变量

```javascript
// config/xfyun.config.js
module.exports = {
  xfyun: {
    appId: process.env.XFYUN_APP_ID,
    apiKey: process.env.XFYUN_API_KEY,
    apiSecret: process.env.XFYUN_API_SECRET,
    host: 'iat.cn-huabei-1.xf-yun.com',
    path: '/v1'
  }
};
```

---

## 🔍 故障排查

### 问题1：提示「请先配置讯飞API」

**可能原因**：
- 配置文件未创建
- 配置文件路径错误
- 密钥未填写或填写错误

**解决方法**：
```bash
# 1. 检查配置文件是否存在
ls -la config/xfyun.config.js

# 2. 检查文件内容
cat config/xfyun.config.js

# 3. 确认密钥已正确填写（非空字符串）
```

### 问题2：Git提交时包含敏感文件

**紧急处理**：

```bash
# 1. 立即撤销最近的提交（如果已提交）
git reset --soft HEAD~1

# 2. 将文件添加到.gitignore
echo "config/xfyun.config.js" >> .gitignore

# 3. 从Git历史中彻底删除文件
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch config/xfyun.config.js" \
  --prune-empty --tag-name-filter cat -- --all

# 4. 强制推送（谨慎使用！）
git push origin --force --all
```

**预防措施**：

```bash
# 安装 git-secrets 工具
brew install git-secrets  # macOS
# 或
apt-get install git-secrets  # Ubuntu

# 配置自动检测
git secrets --install
git secrets --register-aws
git secrets --add 'apiSecret'
git secrets --add 'apiKey'
```

### 问题3：配置文件被团队成员意外提交

**处理流程**：

1. **通知团队立即更换密钥**
   - 登录讯飞控制台
   - 删除旧密钥或重新生成

2. **检查Git历史**
   ```bash
   git log --all --full-history --source -- "*xfyun.config.js"
   ```

3. **从所有分支中删除**
   ```bash
   git filter-branch --force --index-filter \
     "git rm --cached --ignore-unmatch config/xfyun.config.js" \
     --prune-empty --tag-name-filter cat -- --all
   ```

4. **通知所有团队成员**
   - 执行 `git pull --rebase`
   - 检查本地是否有敏感文件

---

## 📋 配置文件检查清单

在提交代码前，请确认：

- [ ] `config/xfyun.config.js` 在 `.gitignore` 中
- [ ] 配置文件中没有硬编码的真实密钥
- [ ] 示例配置文件 `config/xfyun.config.example.js` 已更新
- [ ] 代码中使用了相对路径引入配置文件
- [ ] 日志中不包含敏感信息
- [ ] 已测试配置文件加载正常

---

## 🔗 相关文档

- [语音识别配置指南](./语音识别配置指南.md)
- [讯飞开放平台文档](https://www.xfyun.cn/doc)
- [Git忽略文件最佳实践](https://git-scm.com/docs/gitignore)

---

## 📞 紧急联系

如果发现安全问题或密钥泄露，请立即：

1. **停止使用泄露的密钥**
2. **在讯飞控制台重置密钥**
3. **通知项目负责人**
4. **检查访问日志是否有异常**

---

**文档版本**: v1.0.0
**最后更新**: 2025-01-31
**维护者**: 开发团队
