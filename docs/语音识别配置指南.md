# 科大讯飞语音识别配置指南

## 📋 功能说明

本项目已集成科大讯飞**方言识别大模型**，支持以下功能：

- ✅ **202种方言**免切换识别（普通话、英语、粤语、四川话等）
- ✅ 实时语音转文字
- ✅ 最长60秒连续录音
- ✅ 识别结果自动填充到输入框

---

## 🔧 配置步骤

### 1️⃣ 注册讯飞开放平台账号

1. 访问 [讯飞开放平台官网](https://www.xfyun.cn/)
2. 点击右上角「注册/登录」
3. 完成账号注册和实名认证

### 2️⃣ 创建应用并获取密钥

1. 登录后进入**控制台**
2. 点击左侧菜单「我的应用」
3. 点击「创建新应用」
4. 填写应用名称和描述，提交

### 3️⃣ 添加语音识别服务

1. 在创建的应用中，点击「添加新服务」
2. 选择 **「方言识别大模型」**（注意：不是普通的「语音听写」）
3. 阅读服务协议并同意

### 4️⃣ 获取API密钥

在应用详情页面，可以看到三个重要参数：

| 参数名 | 说明 | 示例 |
|--------|------|------|
| **APPID** | 应用ID | `5f8e3d2a` |
| **APIKey** | API密钥 | `7462e2c3-ffa0-4da7-9227-5f78c59305d8` |
| **APISecret** | API密钥 | `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6` |

**⚠️ 重要提示**：请妥善保管这三个参数，不要泄露到公开仓库！

---

## 💻 代码配置

### 修改配置文件

打开文件：`pages/chatting/chatting.js`

找到第 33-39 行的 `xfyun` 配置对象：

```javascript
// 科大讯飞配置
xfyun: {
    appId: '',              // ← 填入你的 APPID
    apiKey: '',             // ← 填入你的 APIKey
    apiSecret: '',          // ← 填入你的 APISecret
    host: 'iat.cn-huabei-1.xf-yun.com',
    path: '/v1'
}
```

将你在讯飞控制台获取的三个参数填入对应位置：

```javascript
xfyun: {
    appId: '5f8e3d2a',              // 你的APPID
    apiKey: '7462e2c3-ffa0-4da7-9227-5f78c59305d8',  // 你的APIKey
    apiSecret: 'a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6',     // 你的APISecret
    host: 'iat.cn-huabei-1.xf-yun.com',
    path: '/v1'
}
```

### 保存配置

保存文件后，重新编译小程序即可生效。

---

## 🎤 使用方法

### 基本使用流程

1. **启动录音**
   - 点击聊天输入框旁边的 **麦克风按钮**（灰色圆形图标）
   - 按钮变为红色，表示正在录音
   - 屏幕显示「开始录音...」提示

2. **说话**
   - 按住麦克风说话（支持普通话、方言、英语）
   - 最长可录制 60 秒
   - 建议每次说话控制在 10-30 秒内，识别效果最佳

3. **停止录音**
   - 再次点击麦克风按钮（红色）
   - 系统自动上传音频并识别
   - 识别结果自动填充到输入框

4. **发送消息**
   - 确认识别结果无误
   - 点击发送按钮（蓝色飞机图标）
   - 消息发送到智能助手

### 支持的方言列表

科大讯飞方言识别大模型支持 **202种方言**，包括但不限于：

| 方言区域 | 代表方言 |
|---------|---------|
| **华北** | 北京话、天津话、河北话、山西话、内蒙古话 |
| **东北** | 东北话、辽宁话、吉林话、黑龙江话 |
| **华东** | 上海话、南京话、杭州话、宁波话、温州话 |
| **华南** | 粤语（广东话）、客家话、闽南语、福州话 |
| **华中** | 武汉话、长沙话、南昌话 |
| **西南** | 四川话、重庆话、云南话、贵州话 |
| **西北** | 西安话、兰州话、银川话 |

> 💡 提示：无需手动选择方言，系统会**自动识别**！

---

## ⚙️ 高级配置（可选）

### 调整录音参数

如需调整录音质量和时长，修改 `pages/chatting/chatting.js` 第 818-824 行：

```javascript
that.recorderManager.start({
    duration: 60000,        // 录音时长（毫秒），默认60秒
    sampleRate: 16000,      // 采样率，建议16000或8000
    numberOfChannels: 1,    // 声道数，1=单声道，2=立体声
    encodeBitRate: 48000,   // 编码比特率
    format: 'mp3'          // 音频格式，支持mp3/aac
});
```

### 调整识别参数

修改 `pages/chatting/chatting.js` 第 975-979 行的识别参数：

```javascript
iat: {
    language: 'zh_cn',      // 语言：zh_cn=中文
    accent: 'mulacc',       // 方言：mulacc=202种方言自动识别
    domain: 'slm',          // 领域：slm=方言大模型
    ptt: 1                  // 标点预测：0=关闭，1=开启
}
```

---

## 🐛 常见问题

### 1. 提示「请先配置讯飞API」

**原因**：未填写API密钥或密钥填写错误

**解决方法**：
- 检查 `chatting.js` 中的 `xfyun` 配置是否已填写
- 确认复制粘贴的密钥没有多余空格

### 2. 提示「语音识别连接失败」

**可能原因**：
- 网络连接不稳定
- API密钥配置错误
- APPID未开通方言识别服务

**解决方法**：
- 检查网络连接
- 确认在讯飞控制台已添加「方言识别大模型」服务
- 检查控制台是否有错误日志

### 3. 识别结果不准确

**优化建议**：
- 在安静环境下录音
- 说话清晰，语速适中
- 靠近手机麦克风（10-30cm距离）
- 每次说话控制在10-30秒

### 4. WebSocket连接建立但无识别结果

**可能原因**：
- 音频数据格式不匹配
- 微信小程序录音格式与讯飞要求不符

**临时解决方案**：
- 当前版本为简化实现，录音结束后才识别
- 如需实时流式识别，需要服务端进行音频格式转换（MP3 → PCM）

---

## 📊 费用说明

### 免费额度

讯飞开放平台为新用户提供**免费试用额度**：
- 方言识别：通常为 **500次/天** 或 **5万字符/月**
- 具体额度以控制台显示为准

### 超出额度

当免费额度用完后：
- 按次计费：约 **0.004元/次**
- 按字符计费：约 **0.00016元/字符**
- 建议购买套餐包获得更低单价

查看详细价格：[讯飞开放平台定价](https://www.xfyun.cn/price)

---

## 📱 权限配置

确保在 `app.json` 中添加了以下权限：

```json
{
  "permission": {
    "scope.record": {
      "desc": "需要使用你的麦克风进行语音输入"
    }
  }
}
```

---

## 🔒 安全建议

1. **不要将API密钥提交到公开仓库**
   - 使用环境变量或配置文件
   - 将 `chatting.js` 添加到 `.gitignore`

2. **配置服务器端验证（生产环境推荐）**
   - 将API密钥保存在服务器
   - 小程序通过你的服务器中转请求

3. **设置每日使用上限**
   - 在讯飞控制台设置每日最大调用量
   - 避免意外产生高额费用

---

## 📞 技术支持

如遇到问题，可通过以下方式获取帮助：

1. **讯飞官方文档**：[方言识别大模型协议](https://www.xfyun.cn/doc/spark/spark_slm_iat.html)
2. **讯飞开发者社区**：[https://www.xfyun.cn/community](https://www.xfyun.cn/community)
3. **提交工单**：讯飞控制台 → 工单系统

---

## 📝 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0.0 | 2025-01-31 | 初始版本，支持科大讯飞方言识别大模型 |

---

## 🎯 后续优化计划

- [ ] 支持实时流式识别（边说边转）
- [ ] 添加语音波形可视化
- [ ] 支持长音频自动分段识别
- [ ] 添加识别结果编辑功能
- [ ] 支持多语言切换（中英文混合）

---

**文档版本**: v1.0.0
**最后更新**: 2025-01-31
